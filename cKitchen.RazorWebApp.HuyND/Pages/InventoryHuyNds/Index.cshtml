@page
@model cKitchen.RazorWebApp.HuyND.Pages.InventoryHuyNds.IndexModel

@{
    ViewData["Title"] = "Inventory";
}

<div class="container mt-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">📦 Inventory Management</h2>
        <!-- Razor Pages: use asp-page + GET so OnGet reads Request.Query -->
        <form method="get" asp-page="./Index">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">BatchNum</label>
                        <input type="text" id="batchNum" name="batchNum" class="form-control"
                               value="@(Request.Query["batchNum"])" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Quantity(Qty)</label>
                        <input type="text" id="quantity" name="quantity" class="form-control"
                               value="@(Request.Query["quantity"])" />
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="control-label">Location</label>
                        <input type="text" id="localName" name="localName" class="form-control"
                               value="@(Request.Query["localName"])" />
                    </div>
                </div>
                <div class="col-md-3 mt-4">
                    <div class="form-group">
                        <input type="submit" value="Search" class="btn btn-success" />
                        <a asp-page="./Create" class="btn btn-primary">Create</a>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Card -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0 align-middle table-bordered text-center">
                <thead class="table-dark">
                    <tr class="text-center">
                        <th>ID</th>
                        <th>Item Name</th>
                        <th>Qty</th>
                        <th>Unit</th>
                        <th>Expiry</th>
                        <th>Batch</th>
                        <th>Status</th>
                        <th>Cost</th>
                        <th>Active</th>
                        <th>Location</th>
                        <th style="width: 200px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-table-body">
                    @if (Model.InventoryHuyNd == null || !Model.InventoryHuyNd.Any())
                    {
                        <tr>
                            <td colspan="11" class="text-center text-muted py-4">
                                No inventory items found.
                            </td>
                        </tr>
                    }
                    else
                    {
                    @foreach (var item in Model.InventoryHuyNd)
                    {
                        <tr id="@item.InventoryHuyNdid" class="inventory-row">
                            <td class="text-center">@item.InventoryHuyNdid</td>

                            <td class="fw-semibold">@item.ItemName</td>

                            <td class="text-center">@item.Quantity</td>

                            <td class="text-center">@item.Unit</td>

                            <td class="text-center">
                                @item.ExpiryDate?.ToString("dd/MM/yyyy")
                            </td>

                            <td>@item.BatchNumber</td>

                            <td class="text-center">
                                <span class="badge bg-info">
                                    @item.Status
                                </span>
                            </td>

                            <td class="text-end text-center">
                                @(item.Cost?.ToString("N0") ?? "0") 
                            </td>

                            <td class="text-center">
                                @if (item.IsActive == true)
                                {
                                    <span class="badge bg-success">Active</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Inactive</span>
                                }
                            </td>


                            <td class="text-center">@item.InventoryLocationHuyNd?.LocationName</td>

                            <td class="text-center">
                                <a asp-page="./Edit" asp-route-id="@item.InventoryHuyNdid"
                                   class="btn btn-sm btn-warning me-1">
                                    Edit
                                </a>
                                <a asp-page="./Details" asp-route-id="@item.InventoryHuyNdid"
                                   class="btn btn-sm btn-info me-1">
                                    View
                                </a>
                                <a asp-page="./Delete" asp-route-id="@item.InventoryHuyNdid"
                                   class="btn btn-sm btn-danger">
                                    Delete
                                </a>
                            </td>
                        </tr>
                    }
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div id="light-pagination" class="d-flex justify-content-center my-3"></div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const rows = Array.from(document.querySelectorAll('#inventory-table-body .inventory-row'));
            const container = document.getElementById('light-pagination');
            const itemsPerPage = 7;

            if (!container) return;
            if (rows.length <= itemsPerPage) {
                container.innerHTML = '';
                return; // không cần phân trang nếu ít dòng
            }

            let currentPage = 1;
            const totalPages = Math.ceil(rows.length / itemsPerPage);

            function renderPage(page) {
                currentPage = page;
                const start = (page - 1) * itemsPerPage;
                const end = start + itemsPerPage;

                rows.forEach((row, index) => {
                    row.style.display = (index >= start && index < end) ? '' : 'none';
                });

                updatePagination();
            }

            function updatePagination() {
                container.innerHTML = '';
                const ul = document.createElement('ul');
                ul.className = 'pagination';

                const createPageItem = (text, page, disabled = false, active = false) => {
                    const li = document.createElement('li');
                    li.className = 'page-item';
                    if (disabled) li.classList.add('disabled');
                    if (active) li.classList.add('active');

                    const a = document.createElement('a');
                    a.className = 'page-link';
                    a.href = '#';
                    a.textContent = text;
                    if (!disabled) {
                        a.addEventListener('click', function (e) {
                            e.preventDefault();
                            renderPage(page);
                        });
                    }

                    li.appendChild(a);
                    return li;
                };

                // Prev
                ul.appendChild(createPageItem('Prev', currentPage - 1, currentPage === 1));

                // Pages
                for (let i = 1; i <= totalPages; i++) {
                    ul.appendChild(createPageItem(i.toString(), i, false, i === currentPage));
                }

                // Next
                ul.appendChild(createPageItem('Next', currentPage + 1, currentPage === totalPages));

                container.appendChild(ul);
            }

            // Khởi tạo trang đầu tiên
            renderPage(1);
        });
    </script>
}
<script src="~/js/signalr/dist/browser/signalr.js"> </script>
<script>
    "use strict";

    var connection = new signalR.HubConnectionBuilder().withUrl("/cKitchenHub").build();

    connection.start().then(function () {
        console.log("HuyND: Connected to the SignalR Hub");
    }).catch(function (err) {
        return console.error(err.toString());
    });

    connection.on("ReceiverDelete_InventoryHuyND", function (InventoryHuyNDId) {
        //alert($(`#${CashDepositSlipId}`).value);
        $('#inventory-table-body').find(`tr[id='${InventoryHuyNDId}']`).remove();
    });
</script>